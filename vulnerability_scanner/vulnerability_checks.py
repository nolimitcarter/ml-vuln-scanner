import nmap
import logging

# Set up logger
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def check_ip_vulnerabilities(ip):
    """
    Perform a vulnerability scan on a given IP address using Nmap's NSE scripts.
    """
    logger.info(f"Starting vulnerability scan for IP: {ip}")
    
    nm = nmap.PortScanner()
    
    try:
        # Perform the scan with Nmap
        # -sV: Version detection (which identifies service versions running on open ports)
        # --script=vuln: Run Nmap's vulnerability detection scripts
        nm.scan(ip, arguments='-sV --script=vuln')
        
        # Check the scan results
        if ip in nm.all_hosts():
            logger.info(f"Scan results for {ip}:")
            host_info = nm[ip]
            
            # Check the state of each port
            if 'hostnames' in host_info:
                logger.info(f"Hostnames: {host_info['hostnames']}")
            
            if 'addresses' in host_info:
                logger.info(f"Addresses: {host_info['addresses']}")
            
            if 'osmatch' in host_info:
                logger.info(f"OS: {host_info['osmatch']}")
            
            # Check the vulnerabilities
            if 'script' in host_info:
                vulnerabilities = host_info['script']
                if vulnerabilities:
                    logger.info(f"Vulnerabilities found for {ip}:")
                    for vulnerability, details in vulnerabilities.items():
                        logger.info(f"  {vulnerability}: {details}")
                else:
                    logger.info(f"No vulnerabilities found for {ip}")
            else:
                logger.info(f"No vulnerability information available for {ip}")
        else:
            logger.warning(f"No information found for {ip}. It might be down or unreachable.")
            
    except Exception as e:
        logger.error(f"An error occurred while scanning {ip}: {e}")
        return None

    return nm[ip]
